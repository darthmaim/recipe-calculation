import { craftingSteps } from '../src'
import { RecipeTreeWithCraftFlags } from '../src/types'

describe('craftingSteps', () => {
  it('gets the correct crafting steps', () => {
    const tree: RecipeTreeWithCraftFlags = {
      craft: true,
      craftDecisionPrice: 6,
      id: 1,
      totalQuantity: 2,
      usedQuantity: 2,
      output: 2,
      type: 'Recipe',
      quantity: 2,
      min_rating: null,
      buyPriceEach: 1,
      buyPrice: 1,
      decisionPrice: 1,
      craftResultPrice: 1,
      disciplines: [],
      components: [
        {
          craft: true,
          craftDecisionPrice: 1,
          id: 7,
          totalQuantity: 6,
          usedQuantity: 6,
          quantity: 6,
          type: 'Recipe',
          buyPriceEach: 1,
          buyPrice: 1,
          decisionPrice: 1,
          craftResultPrice: 1,
          output: 1,
          min_rating: 400,
          disciplines: ['Armorsmith'],
          prerequisites: [
            {
              type: 'Recipe',
              id: 123,
            },
          ],
          components: [
            {
              craft: false,
              craftDecisionPrice: 1,
              id: 4,
              totalQuantity: 12,
              usedQuantity: 12,
              type: 'Item',
              quantity: 12,
              output: 1,
              min_rating: null,
              buyPriceEach: 1,
              buyPrice: 1,
              decisionPrice: 1,
              craftResultPrice: 1,
              disciplines: [],
              prerequisites: [],
            },
          ],
        },
        {
          craft: true,
          craftDecisionPrice: 1,
          id: 3,
          totalQuantity: 10,
          usedQuantity: 3,
          output: 1,
          type: 'Recipe',
          quantity: 10,
          min_rating: null,
          disciplines: [],
          buyPrice: 1,
          buyPriceEach: 1,
          decisionPrice: 1,
          craftResultPrice: 1,
          components: [
            {
              craft: true,
              craftDecisionPrice: 1,
              id: 19,
              totalQuantity: 3,
              usedQuantity: 3,
              output: 1,
              type: 'Recipe',
              quantity: 3,
              min_rating: null,
              disciplines: [],
              buyPrice: 1,
              buyPriceEach: 1,
              decisionPrice: 1,
              craftResultPrice: 1,
              components: [
                {
                  craft: true,
                  craftDecisionPrice: 1,
                  id: 7,
                  totalQuantity: 3,
                  usedQuantity: 3,
                  output: 1,
                  type: 'Recipe',
                  quantity: 3,
                  min_rating: null,
                  disciplines: [],
                  buyPrice: 1,
                  buyPriceEach: 1,
                  decisionPrice: 1,
                  craftResultPrice: 1,
                  components: [
                    {
                      craft: false,
                      craftDecisionPrice: 1,
                      id: 4,
                      totalQuantity: 6,
                      usedQuantity: 6,
                      type: 'Item',
                      quantity: 6,
                      output: 1,
                      min_rating: null,
                      buyPriceEach: 1,
                      buyPrice: 1,
                      decisionPrice: 1,
                      craftResultPrice: 1,
                      disciplines: [],
                      prerequisites: [],
                    },
                  ],
                  prerequisites: [],
                },
              ],
              prerequisites: [],
            },
          ],
          prerequisites: [],
        },
        {
          craft: false,
          craftDecisionPrice: 1,
          id: 5,
          totalQuantity: 4,
          usedQuantity: 0,
          output: 1,
          type: 'Recipe',
          quantity: 4,
          min_rating: null,
          buyPriceEach: 1,
          buyPrice: 1,
          decisionPrice: 1,
          craftResultPrice: 1,
          disciplines: [],
          components: [
            {
              craft: false,
              craftDecisionPrice: 1,
              id: 6,
              totalQuantity: 0,
              usedQuantity: 0,
              type: 'Item',
              quantity: 0,
              output: 1,
              min_rating: null,
              buyPriceEach: 1,
              buyPrice: 1,
              decisionPrice: 1,
              craftResultPrice: 1,
              disciplines: [],
              prerequisites: [],
            },
          ],
          prerequisites: [],
        },
        {
          craft: true,
          craftDecisionPrice: 1,
          id: 15,
          totalQuantity: 1,
          usedQuantity: 1,
          output: 1,
          type: 'Recipe',
          quantity: 1,
          min_rating: null,
          buyPriceEach: 1,
          buyPrice: 1,
          decisionPrice: 1,
          craftResultPrice: 1,
          disciplines: [],
          components: [
            {
              craft: true,
              craftDecisionPrice: 1,
              id: 7,
              totalQuantity: 6,
              usedQuantity: 6,
              output: 1,
              type: 'Recipe',
              quantity: 6,
              min_rating: null,
              buyPriceEach: 1,
              buyPrice: 1,
              decisionPrice: 1,
              craftResultPrice: 1,
              disciplines: [],
              components: [
                {
                  craft: false,
                  craftDecisionPrice: 1,
                  id: 4,
                  totalQuantity: 12,
                  usedQuantity: 12,
                  type: 'Item',
                  quantity: 12,
                  output: 1,
                  min_rating: null,
                  buyPriceEach: 1,
                  buyPrice: 1,
                  decisionPrice: 1,
                  craftResultPrice: 1,
                  disciplines: [],
                  prerequisites: [],
                },
              ],
              prerequisites: [],
            },
          ],
          prerequisites: [],
        },
        {
          craft: true,
          craftDecisionPrice: 1,
          id: 1337,
          totalQuantity: 1,
          usedQuantity: 0,
          output: 1,
          type: 'Recipe',
          quantity: 1,
          min_rating: null,
          buyPriceEach: 1,
          buyPrice: 1,
          decisionPrice: 1,
          craftResultPrice: 1,
          disciplines: [],
          components: [
            {
              craft: true,
              craftDecisionPrice: 1,
              id: 42,
              totalQuantity: 6,
              usedQuantity: 6,
              output: 1,
              type: 'Item',
              quantity: 6,
              min_rating: null,
              buyPriceEach: 1,
              buyPrice: 1,
              decisionPrice: 1,
              craftResultPrice: 1,
              disciplines: [],
              prerequisites: [],
            },
          ],
          prerequisites: [],
        },
        {
          craft: true,
          craftDecisionPrice: 1,
          id: 1,
          totalQuantity: 6,
          usedQuantity: 6,
          output: 1,
          type: 'Currency',
          quantity: 6,
          min_rating: null,
          buyPriceEach: 1,
          buyPrice: 1,
          decisionPrice: 1,
          craftResultPrice: 1,
          disciplines: [],
          prerequisites: [],
        },
      ],
      prerequisites: [],
    }

    const usedItemObject = craftingSteps(tree)
    expect(usedItemObject).toMatchSnapshot()
  })

  it('gets the correct crafting steps with mystic clovers', () => {
    const tree: RecipeTreeWithCraftFlags = {
      craft: true,
      craftDecisionPrice: 4,
      id: 1,
      totalQuantity: 2,
      usedQuantity: 2,
      output: 2,
      type: 'Recipe',
      quantity: 2,
      min_rating: null,
      buyPriceEach: 1,
      buyPrice: 1,
      decisionPrice: 1,
      craftResultPrice: 1,
      disciplines: [],
      components: [
        {
          craft: true,
          craftDecisionPrice: 1,
          id: 7,
          totalQuantity: 6,
          usedQuantity: 6,
          quantity: 6,
          type: 'Recipe',
          buyPriceEach: 1,
          buyPrice: 1,
          decisionPrice: 1,
          craftResultPrice: 1,
          output: 1,
          min_rating: 400,
          disciplines: ['Armorsmith'],
          prerequisites: [
            {
              type: 'Recipe',
              id: 123,
            },
          ],
          components: [
            {
              craft: false,
              craftDecisionPrice: 1,
              id: 4,
              totalQuantity: 12,
              usedQuantity: 12,
              type: 'Item',
              quantity: 12,
              output: 1,
              min_rating: null,
              buyPriceEach: 1,
              buyPrice: 1,
              decisionPrice: 1,
              craftResultPrice: 1,
              disciplines: [],
              prerequisites: [],
            },
          ],
        },
        {
          craft: true,
          craftDecisionPrice: 1,
          id: 3,
          totalQuantity: 10,
          usedQuantity: 3,
          output: 1,
          type: 'Recipe',
          quantity: 10,
          min_rating: null,
          disciplines: [],
          buyPrice: 1,
          buyPriceEach: 1,
          decisionPrice: 1,
          craftResultPrice: 1,
          components: [
            {
              craft: true,
              craftDecisionPrice: 1,
              id: 19,
              totalQuantity: 3,
              usedQuantity: 3,
              output: 1,
              type: 'Recipe',
              quantity: 3,
              min_rating: null,
              disciplines: [],
              buyPrice: 1,
              buyPriceEach: 1,
              decisionPrice: 1,
              craftResultPrice: 1,
              components: [
                {
                  craft: true,
                  craftDecisionPrice: 99210,
                  id: 19675,
                  totalQuantity: 3,
                  usedQuantity: 3,
                  output: 1,
                  type: 'Recipe',
                  quantity: 3,
                  min_rating: null,
                  disciplines: [],
                  buyPrice: 1,
                  buyPriceEach: 1,
                  decisionPrice: 1,
                  craftResultPrice: 1,
                  components: [
                    {
                      craft: true,
                      craftDecisionPrice: 0,
                      id: 19925,
                      type: 'Recipe',
                      quantity: 1,
                      output: 1,
                      components: [
                        {
                          craft: false,
                          craftDecisionPrice: false,
                          id: 19,
                          type: 'Currency',
                          quantity: 25,
                          output: 1,
                          totalQuantity: 250,
                          usedQuantity: 250,
                          buyPriceEach: false,
                          buyPrice: false,
                          decisionPrice: false,
                          craftResultPrice: false,
                          min_rating: null,
                          disciplines: [],
                          prerequisites: [],
                        },
                        {
                          craft: false,
                          craftDecisionPrice: false,
                          id: 2,
                          type: 'Currency',
                          quantity: 1050,
                          output: 1,
                          totalQuantity: 10500,
                          usedQuantity: 10500,
                          buyPriceEach: false,
                          buyPrice: false,
                          decisionPrice: false,
                          craftResultPrice: false,
                          min_rating: null,
                          disciplines: [],
                          prerequisites: [],
                        },
                      ],
                      prerequisites: [],
                      min_rating: null,
                      disciplines: ['Merchant'],
                      merchant: {
                        name: 'Foo',
                        locations: ['Bar'],
                      },
                      totalQuantity: 10,
                      usedQuantity: 10,
                      buyPriceEach: false,
                      buyPrice: false,
                      decisionPrice: 0,
                      craftResultPrice: 0,
                      craftPrice: 0,
                    },
                    {
                      craft: false,
                      craftDecisionPrice: 85920,
                      id: 19976,
                      type: 'Item',
                      quantity: 1,
                      output: 1,
                      totalQuantity: 10,
                      usedQuantity: 10,
                      buyPriceEach: 8592,
                      buyPrice: 85920,
                      decisionPrice: 85920,
                      craftResultPrice: 85920,
                      min_rating: null,
                      disciplines: [],
                      prerequisites: [],
                    },
                    {
                      craft: false,
                      craftDecisionPrice: 13290,
                      id: 19721,
                      type: 'Item',
                      quantity: 1,
                      output: 1,
                      totalQuantity: 10,
                      usedQuantity: 10,
                      buyPriceEach: 1329,
                      buyPrice: 13290,
                      decisionPrice: 13290,
                      craftResultPrice: 13290,
                      min_rating: null,
                      disciplines: [],
                      prerequisites: [],
                    },
                    {
                      craft: true,
                      craftDecisionPrice: 0,
                      id: 20796,
                      type: 'Recipe',
                      quantity: 6,
                      output: 10,
                      components: [
                        {
                          craft: false,
                          craftDecisionPrice: false,
                          id: 23,
                          type: 'Currency',
                          quantity: 1,
                          output: 1,
                          totalQuantity: 6,
                          usedQuantity: 6,
                          buyPriceEach: false,
                          buyPrice: false,
                          decisionPrice: false,
                          craftResultPrice: false,
                          min_rating: null,
                          disciplines: [],
                          prerequisites: [],
                        },
                      ],
                      prerequisites: [],
                      min_rating: null,
                      disciplines: ['Merchant'],
                      merchant: {
                        name: 'Foo',
                        locations: ['Bar'],
                      },
                      totalQuantity: 60,
                      usedQuantity: 60,
                      buyPriceEach: false,
                      buyPrice: false,
                      decisionPrice: 0,
                      craftResultPrice: 0,
                      craftPrice: 0,
                    },
                  ],
                  prerequisites: [],
                },
              ],
              prerequisites: [],
            },
          ],
          prerequisites: [],
        },
        {
          craft: false,
          craftDecisionPrice: 1,
          id: 5,
          totalQuantity: 4,
          usedQuantity: 0,
          output: 1,
          type: 'Recipe',
          quantity: 4,
          min_rating: null,
          buyPriceEach: 1,
          buyPrice: 1,
          decisionPrice: 1,
          craftResultPrice: 1,
          disciplines: [],
          components: [
            {
              craft: false,
              craftDecisionPrice: 1,
              id: 6,
              totalQuantity: 0,
              usedQuantity: 0,
              type: 'Item',
              quantity: 0,
              output: 1,
              min_rating: null,
              buyPriceEach: 1,
              buyPrice: 1,
              decisionPrice: 1,
              craftResultPrice: 1,
              disciplines: [],
              prerequisites: [],
            },
          ],
          prerequisites: [],
        },
        {
          craft: true,
          craftDecisionPrice: 1,
          id: 15,
          totalQuantity: 1,
          usedQuantity: 1,
          output: 1,
          type: 'Recipe',
          quantity: 1,
          min_rating: null,
          buyPriceEach: 1,
          buyPrice: 1,
          decisionPrice: 1,
          craftResultPrice: 1,
          disciplines: [],
          components: [
            {
              craft: true,
              craftDecisionPrice: 1,
              id: 7,
              totalQuantity: 6,
              usedQuantity: 6,
              output: 1,
              type: 'Recipe',
              quantity: 6,
              min_rating: null,
              buyPriceEach: 1,
              buyPrice: 1,
              decisionPrice: 1,
              craftResultPrice: 1,
              disciplines: [],
              components: [
                {
                  craft: false,
                  craftDecisionPrice: 1,
                  id: 4,
                  totalQuantity: 12,
                  usedQuantity: 12,
                  type: 'Item',
                  quantity: 12,
                  output: 1,
                  min_rating: null,
                  buyPriceEach: 1,
                  buyPrice: 1,
                  decisionPrice: 1,
                  craftResultPrice: 1,
                  disciplines: [],
                  prerequisites: [],
                },
              ],
              prerequisites: [],
            },
          ],
          prerequisites: [],
        },
      ],
      prerequisites: [],
    }

    const usedItemObject = craftingSteps(tree)
    expect(usedItemObject).toMatchSnapshot()
  })

  it('gets the correct crafting steps when merging components', () => {
    const tree: RecipeTreeWithCraftFlags = {
      craft: true,
      craftDecisionPrice: 2,
      id: 1,
      totalQuantity: 1,
      usedQuantity: 1,
      output: 1,
      type: 'Recipe',
      quantity: 1,
      min_rating: null,
      disciplines: [],
      buyPrice: 1,
      buyPriceEach: 1,
      decisionPrice: 1,
      craftResultPrice: 1,
      components: [
        {
          craft: true,
          craftDecisionPrice: 2,
          id: 2,
          totalQuantity: 1,
          usedQuantity: 1,
          output: 1,
          type: 'Recipe',
          quantity: 1,
          min_rating: null,
          disciplines: [],
          buyPrice: 1,
          buyPriceEach: 1,
          decisionPrice: 1,
          craftResultPrice: 1,
          components: [
            {
              craft: false,
              craftDecisionPrice: 1,
              id: 3,
              totalQuantity: 1,
              usedQuantity: 0,
              output: 1,
              type: 'Recipe',
              quantity: 1,
              min_rating: null,
              disciplines: [],
              buyPrice: 1,
              buyPriceEach: 1,
              decisionPrice: 1,
              craftResultPrice: 1,
              components: [
                {
                  craft: false,
                  craftDecisionPrice: 1,
                  id: 4,
                  totalQuantity: 1,
                  usedQuantity: 1,
                  output: 1,
                  type: 'Item',
                  quantity: 1,
                  min_rating: null,
                  buyPriceEach: 1,
                  buyPrice: 1,
                  decisionPrice: 1,
                  craftResultPrice: 1,
                  disciplines: [],
                  prerequisites: [],
                },
              ],
              prerequisites: [],
            },
            {
              craft: true,
              craftDecisionPrice: 1,
              id: 5,
              totalQuantity: 1,
              usedQuantity: 1,
              output: 1,
              type: 'Recipe',
              quantity: 1,
              min_rating: null,
              disciplines: [],
              buyPrice: 1,
              buyPriceEach: 1,
              decisionPrice: 1,
              craftResultPrice: 1,
              components: [
                {
                  craft: false,
                  craftDecisionPrice: 1,
                  id: 6,
                  totalQuantity: 1,
                  usedQuantity: 1,
                  output: 1,
                  type: 'Item',
                  quantity: 1,
                  min_rating: null,
                  buyPriceEach: 1,
                  buyPrice: 1,
                  decisionPrice: 1,
                  craftResultPrice: 1,
                  disciplines: [],
                  prerequisites: [],
                },
              ],
              prerequisites: [],
            },
          ],
          prerequisites: [],
        },
        {
          craft: true,
          craftDecisionPrice: 2,
          id: 2,
          totalQuantity: 1,
          usedQuantity: 1,
          output: 1,
          type: 'Recipe',
          quantity: 1,
          min_rating: null,
          disciplines: [],
          buyPrice: 1,
          buyPriceEach: 1,
          decisionPrice: 1,
          craftResultPrice: 1,
          components: [
            {
              craft: true,
              craftDecisionPrice: 1,
              id: 3,
              totalQuantity: 1,
              usedQuantity: 1,
              output: 1,
              type: 'Recipe',
              quantity: 1,
              min_rating: null,
              disciplines: [],
              buyPrice: 1,
              buyPriceEach: 1,
              decisionPrice: 1,
              craftResultPrice: 1,
              components: [
                {
                  craft: false,
                  craftDecisionPrice: 1,
                  id: 4,
                  totalQuantity: 1,
                  usedQuantity: 1,
                  output: 1,
                  type: 'Item',
                  quantity: 1,
                  min_rating: null,
                  buyPriceEach: 1,
                  buyPrice: 1,
                  decisionPrice: 1,
                  craftResultPrice: 1,
                  disciplines: [],
                  prerequisites: [],
                },
              ],
              prerequisites: [],
            },
            {
              craft: true,
              craftDecisionPrice: 1,
              id: 5,
              totalQuantity: 1,
              usedQuantity: 1,
              output: 1,
              type: 'Recipe',
              quantity: 1,
              min_rating: null,
              disciplines: [],
              buyPrice: 1,
              buyPriceEach: 1,
              decisionPrice: 1,
              craftResultPrice: 1,
              components: [
                {
                  craft: false,
                  craftDecisionPrice: 1,
                  id: 6,
                  totalQuantity: 1,
                  usedQuantity: 1,
                  output: 1,
                  type: 'Item',
                  quantity: 1,
                  min_rating: null,
                  buyPriceEach: 1,
                  buyPrice: 1,
                  decisionPrice: 1,
                  craftResultPrice: 1,
                  disciplines: [],
                  prerequisites: [],
                },
              ],
              prerequisites: [],
            },
          ],
          prerequisites: [],
        },
      ],
      prerequisites: [],
    }

    const usedItemObject = craftingSteps(tree)

    expect(usedItemObject).toMatchSnapshot()
  })
})
